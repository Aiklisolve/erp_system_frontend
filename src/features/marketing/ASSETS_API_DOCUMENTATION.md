# Marketing Assets API Documentation

This document describes the REST API endpoints for managing Marketing Assets in the ERP system.

## Base URL
```
http://localhost:3000/api/v1/marketing/assets
```

## Authentication
All endpoints require Bearer token authentication:
```
Authorization: Bearer <token>
```

---

## 1. List Assets

Retrieve a list of marketing assets, optionally filtered by campaign.

### Endpoint
```
GET /api/v1/marketing/assets
```

### Query Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `campaign_id` | string | No | Filter assets by campaign ID |

### cURL Example
```bash
# Get all assets
curl -X GET "http://localhost:3000/api/v1/marketing/assets" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json"

# Get assets for a specific campaign
curl -X GET "http://localhost:3000/api/v1/marketing/assets?campaign_id=camp-1" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json"
```

### Success Response (200 OK)
```json
{
  "success": true,
  "data": [
    {
      "id": "1",
      "asset_code": "ASSET-2025-000001",
      "name": "Q1 Launch Banner",
      "type": "IMAGE",
      "url": "https://example.com/assets/banner.jpg",
      "file_size": 245760,
      "campaign_id": "camp-1",
      "tags": ["banner", "launch", "q1"],
      "created_at": "2025-01-01T10:00:00.000Z",
      "updated_at": "2025-01-01T10:00:00.000Z"
    },
    {
      "id": "2",
      "asset_code": "ASSET-2025-000002",
      "name": "Product Demo Video",
      "type": "VIDEO",
      "url": "https://example.com/assets/demo.mp4",
      "file_size": 5242880,
      "campaign_id": "camp-1",
      "tags": ["video", "demo", "product"],
      "created_at": "2025-01-02T10:00:00.000Z",
      "updated_at": "2025-01-02T10:00:00.000Z"
    }
  ],
  "count": 2
}
```

### Alternative Response Format (Array)
```json
[
  {
    "id": "1",
    "asset_code": "ASSET-2025-000001",
    "name": "Q1 Launch Banner",
    "type": "IMAGE",
    "url": "https://example.com/assets/banner.jpg",
    "file_size": 245760,
    "campaign_id": "camp-1",
    "tags": ["banner", "launch", "q1"],
    "created_at": "2025-01-01T10:00:00.000Z",
    "updated_at": "2025-01-01T10:00:00.000Z"
  }
]
```

### Error Response (500 Internal Server Error)
```json
{
  "success": false,
  "message": "Internal server error",
  "error_code": "42P01",
  "timestamp": "2025-01-10T10:41:50.953Z"
}
```

---

## 2. Get Single Asset

Retrieve a single marketing asset by ID.

### Endpoint
```
GET /api/v1/marketing/assets/:id
```

### Path Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | string | Yes | Asset ID |

### cURL Example
```bash
curl -X GET "http://localhost:3000/api/v1/marketing/assets/1" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json"
```

### Success Response (200 OK)
```json
{
  "success": true,
  "data": {
    "id": "1",
    "asset_code": "ASSET-2025-000001",
    "name": "Q1 Launch Banner",
    "type": "IMAGE",
    "url": "https://example.com/assets/banner.jpg",
    "file_size": 245760,
    "campaign_id": "camp-1",
    "tags": ["banner", "launch", "q1"],
    "created_at": "2025-01-01T10:00:00.000Z",
    "updated_at": "2025-01-01T10:00:00.000Z"
  }
}
```

### Error Response (404 Not Found)
```json
{
  "success": false,
  "message": "Asset not found",
  "error_code": "ASSET_NOT_FOUND",
  "timestamp": "2025-01-10T10:41:50.953Z"
}
```

---

## 3. Create Asset

Create a new marketing asset.

### Endpoint
```
POST /api/v1/marketing/assets
```

### Request Body
```json
{
  "name": "Q1 Launch Banner",
  "type": "IMAGE",
  "url": "https://example.com/assets/banner.jpg",
  "file_size": 245760,
  "campaign_id": "camp-1",
  "tags": ["banner", "launch", "q1"]
}
```

### Field Descriptions
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Asset name (max 255 characters) |
| `type` | string | No | Asset type: `IMAGE`, `VIDEO`, `DOCUMENT`, `AUDIO`, `OTHER` |
| `url` | string | No | URL to the asset file (max 500 characters) |
| `file_size` | number | No | File size in bytes |
| `campaign_id` | string | No | Associated campaign ID (foreign key to `marketing_campaigns.id`) |
| `tags` | string[] | No | Array of tag strings |

**Note:** `asset_code` is auto-generated by the backend if not provided.

### cURL Example
```bash
curl -X POST "http://localhost:3000/api/v1/marketing/assets" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Q1 Launch Banner",
    "type": "IMAGE",
    "url": "https://example.com/assets/banner.jpg",
    "file_size": 245760,
    "campaign_id": "camp-1",
    "tags": ["banner", "launch", "q1"]
  }'
```

### Success Response (201 Created)
```json
{
  "success": true,
  "data": {
    "id": "3",
    "asset_code": "ASSET-2025-000003",
    "name": "Q1 Launch Banner",
    "type": "IMAGE",
    "url": "https://example.com/assets/banner.jpg",
    "file_size": 245760,
    "campaign_id": "camp-1",
    "tags": ["banner", "launch", "q1"],
    "created_at": "2025-01-10T10:00:00.000Z",
    "updated_at": "2025-01-10T10:00:00.000Z"
  }
}
```

### Alternative Response Format (Direct Object)
```json
{
  "id": "3",
  "asset_code": "ASSET-2025-000003",
  "name": "Q1 Launch Banner",
  "type": "IMAGE",
  "url": "https://example.com/assets/banner.jpg",
  "file_size": 245760,
  "campaign_id": "camp-1",
  "tags": ["banner", "launch", "q1"],
  "created_at": "2025-01-10T10:00:00.000Z",
  "updated_at": "2025-01-10T10:00:00.000Z"
}
```

### Error Response (400 Bad Request)
```json
{
  "success": false,
  "message": "Validation error",
  "errors": {
    "name": "Asset name is required"
  },
  "timestamp": "2025-01-10T10:41:50.953Z"
}
```

### Error Response (500 Internal Server Error)
```json
{
  "success": false,
  "message": "Internal server error",
  "error_code": "DATABASE_ERROR",
  "timestamp": "2025-01-10T10:41:50.953Z"
}
```

---

## 4. Update Asset

Update an existing marketing asset.

### Endpoint
```
PATCH /api/v1/marketing/assets/:id
```

### Path Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | string | Yes | Asset ID |

### Request Body
All fields are optional. Only include fields that need to be updated.
```json
{
  "name": "Updated Banner Name",
  "type": "VIDEO",
  "url": "https://example.com/assets/updated-banner.jpg",
  "file_size": 512000,
  "campaign_id": "camp-2",
  "tags": ["banner", "updated", "q2"]
}
```

### cURL Example
```bash
curl -X PATCH "http://localhost:3000/api/v1/marketing/assets/1" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Banner Name",
    "type": "VIDEO",
    "url": "https://example.com/assets/updated-banner.jpg",
    "file_size": 512000,
    "campaign_id": "camp-2",
    "tags": ["banner", "updated", "q2"]
  }'
```

### Success Response (200 OK)
```json
{
  "success": true,
  "data": {
    "id": "1",
    "asset_code": "ASSET-2025-000001",
    "name": "Updated Banner Name",
    "type": "VIDEO",
    "url": "https://example.com/assets/updated-banner.jpg",
    "file_size": 512000,
    "campaign_id": "camp-2",
    "tags": ["banner", "updated", "q2"],
    "created_at": "2025-01-01T10:00:00.000Z",
    "updated_at": "2025-01-10T11:00:00.000Z"
  }
}
```

### Alternative Response Format (Direct Object)
```json
{
  "id": "1",
  "asset_code": "ASSET-2025-000001",
  "name": "Updated Banner Name",
  "type": "VIDEO",
  "url": "https://example.com/assets/updated-banner.jpg",
  "file_size": 512000,
  "campaign_id": "camp-2",
  "tags": ["banner", "updated", "q2"],
  "created_at": "2025-01-01T10:00:00.000Z",
  "updated_at": "2025-01-10T11:00:00.000Z"
}
```

### Error Response (404 Not Found)
```json
{
  "success": false,
  "message": "Asset not found",
  "error_code": "ASSET_NOT_FOUND",
  "timestamp": "2025-01-10T10:41:50.953Z"
}
```

### Error Response (400 Bad Request)
```json
{
  "success": false,
  "message": "Validation error",
  "errors": {
    "url": "Invalid URL format"
  },
  "timestamp": "2025-01-10T10:41:50.953Z"
}
```

---

## 5. Delete Asset

Delete a marketing asset.

### Endpoint
```
DELETE /api/v1/marketing/assets/:id
```

### Path Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | string | Yes | Asset ID |

### cURL Example
```bash
curl -X DELETE "http://localhost:3000/api/v1/marketing/assets/1" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json"
```

### Success Response (200 OK)
```json
{
  "success": true,
  "message": "Asset deleted successfully"
}
```

### Alternative Success Response (204 No Content)
```
(No response body)
```

### Error Response (404 Not Found)
```json
{
  "success": false,
  "message": "Asset not found",
  "error_code": "ASSET_NOT_FOUND",
  "timestamp": "2025-01-10T10:41:50.953Z"
}
```

### Error Response (500 Internal Server Error)
```json
{
  "success": false,
  "message": "Internal server error",
  "error_code": "DATABASE_ERROR",
  "timestamp": "2025-01-10T10:41:50.953Z"
}
```

---

## Data Types

### MarketingAsset Object
```typescript
{
  id: string;                    // Auto-generated asset ID (BIGSERIAL)
  asset_code?: string;           // Auto-generated asset code (e.g., "ASSET-2025-000001")
  name: string;                  // Asset name (required, max 255 chars)
  type?: 'IMAGE' | 'VIDEO' | 'DOCUMENT' | 'AUDIO' | 'OTHER';
  url?: string;                  // Asset URL (max 500 chars)
  file_size?: number;            // File size in bytes (BIGINT)
  campaign_id?: string;          // Foreign key to marketing_campaigns.id (nullable)
  tags?: string[];              // Array of tag strings (TEXT[])
  created_at: string;           // ISO 8601 timestamp
  updated_at: string;           // ISO 8601 timestamp
}
```

### Asset Type Enum
- `IMAGE` - Image files (JPG, PNG, GIF, etc.)
- `VIDEO` - Video files (MP4, AVI, MOV, etc.)
- `DOCUMENT` - Document files (PDF, DOC, DOCX, etc.)
- `AUDIO` - Audio files (MP3, WAV, etc.)
- `OTHER` - Other file types

---

## Response Format Notes

The frontend is flexible and can handle multiple response formats:

1. **Wrapped Response:**
   ```json
   {
     "success": true,
     "data": [...]
   }
   ```

2. **Direct Array/Object:**
   ```json
   [...]
   ```
   or
   ```json
   { "id": "...", ... }
   ```

3. **Alternative Wrapped:**
   ```json
   {
     "assets": [...]
   }
   ```

The frontend will automatically parse and normalize these formats.

---

## CORS Configuration

The backend must handle CORS preflight (OPTIONS) requests. See `BACKEND_CORS_CONFIG.md` for details.

### Expected OPTIONS Response Headers
```
Access-Control-Allow-Origin: http://localhost:5173
Access-Control-Allow-Methods: GET, POST, PATCH, DELETE, OPTIONS
Access-Control-Allow-Headers: Authorization, Content-Type
Access-Control-Max-Age: 86400
```

---

## Database Schema Reference

The `marketing_assets` table structure:

```sql
CREATE TABLE public.marketing_assets (
  id BIGSERIAL NOT NULL PRIMARY KEY,
  asset_code VARCHAR(50) UNIQUE,
  name VARCHAR(255) NOT NULL,
  type VARCHAR(50),
  url VARCHAR(500),
  file_size BIGINT,
  campaign_id BIGINT,
  tags TEXT[],
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT marketing_assets_campaign_id_fkey 
    FOREIGN KEY (campaign_id) 
    REFERENCES marketing_campaigns(id) 
    ON DELETE SET NULL
);

CREATE INDEX idx_marketing_assets_campaign_id ON public.marketing_assets(campaign_id);
CREATE INDEX idx_marketing_assets_type ON public.marketing_assets(type);

-- Trigger to auto-generate asset_code
CREATE TRIGGER trigger_generate_asset_code
  BEFORE INSERT ON marketing_assets
  FOR EACH ROW
  WHEN (NEW.asset_code IS NULL OR NEW.asset_code::text = ''::text)
  EXECUTE FUNCTION generate_asset_code();

-- Trigger to update updated_at timestamp
CREATE TRIGGER trigger_update_marketing_assets_updated_at
  BEFORE UPDATE ON marketing_assets
  FOR EACH ROW
  EXECUTE FUNCTION update_marketing_campaigns_updated_at();
```

---

## Example Workflows

### Create and Link Asset to Campaign
```bash
# 1. Create asset
curl -X POST "http://localhost:3000/api/v1/marketing/assets" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Summer Sale Banner",
    "type": "IMAGE",
    "url": "https://cdn.example.com/banners/summer-sale.jpg",
    "file_size": 102400,
    "campaign_id": "camp-5",
    "tags": ["summer", "sale", "banner"]
  }'

# 2. List assets for campaign
curl -X GET "http://localhost:3000/api/v1/marketing/assets?campaign_id=camp-5" \
  -H "Authorization: Bearer <token>"
```

### Update Asset Tags
```bash
curl -X PATCH "http://localhost:3000/api/v1/marketing/assets/10" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "tags": ["summer", "sale", "banner", "2025", "promotion"]
  }'
```

### Delete Unused Asset
```bash
curl -X DELETE "http://localhost:3000/api/v1/marketing/assets/10" \
  -H "Authorization: Bearer <token>"
```

---

## Error Codes

| Error Code | Description |
|------------|-------------|
| `ASSET_NOT_FOUND` | Asset with the given ID does not exist |
| `VALIDATION_ERROR` | Request validation failed |
| `DATABASE_ERROR` | Database operation failed |
| `FOREIGN_KEY_VIOLATION` | Invalid campaign_id reference |
| `UNIQUE_VIOLATION` | Duplicate asset_code |
| `42P01` | Relation (table) does not exist |

---

## Notes

1. **Auto-generated Fields:**
   - `id` - Auto-generated by database (BIGSERIAL)
   - `asset_code` - Auto-generated by trigger if not provided (format: `ASSET-YYYY-NNNNNN`)
   - `created_at` - Auto-set on creation
   - `updated_at` - Auto-updated on modification

2. **Foreign Key:**
   - `campaign_id` references `marketing_campaigns.id`
   - On campaign deletion, `campaign_id` is set to NULL (ON DELETE SET NULL)

3. **Nullable Fields:**
   - All fields except `id` and `name` are nullable
   - Frontend handles null values gracefully

4. **Tags:**
   - Tags are stored as PostgreSQL TEXT[] array
   - Frontend sends as JSON array: `["tag1", "tag2"]`
   - Backend should handle both array and comma-separated string formats

5. **File Size:**
   - Stored as BIGINT (supports very large files)
   - Frontend displays in human-readable format (KB, MB, GB)

